# Map Generation Module â€“ Overview

## Purpose
This document provides a technical overview of the main components in the procedural terrain generation system, their responsibilities, and how they interact.

---

## Components

### 1. `mapgen.c`
**Role:** Main procedural map generation engine  
**Responsibilities:**
- Allocates and populates `MapPoint` array
- Uses Perlin/FBM noise for terrain features
- Performs elevation classification and biome color mapping
- Organizes processing in vectorized blocks for cache and SIMD efficiency

### 2. `perlin3d.c`
**Role:** 3D Perlin noise and fractal Brownian motion  
**Responsibilities:**
- Implements `perlin3()` and `fbm_noise3()` functions
- Supports scalar and SIMD-accelerated versions
- Provides LUT-based and polynomial `fade` options

### 3. `libmapgen.py`
**Role:** Python bindings and interface for testing or visualization  
**Responsibilities:**
- Loads `.bin` file generated by `mapgen`
- Interprets `MapPoint` records from raw binary
- Converts data to NumPy arrays for analysis or rendering

### 4. `run.py`
**Role:** Main execution entrypoint for map generation in batch or testing context  
**Responsibilities:**
- Calls into `libmapgen.py` to generate and optionally save the terrain map
- Allows CLI-based control of generation resolution and file paths

---

## Workflow

1. **Initialization:** `g_map` is prepared with memory allocation
2. **Noise Computation:** `fbm_on_sphere()` called per point using lat/lon
3. **Biome Classification:** elevation thresholds applied; RGB set
4. **Cloud & Precipitation:** Based on latitudinal parameters & additional FBM
5. **Save / Load:** `mapgen_flush()` writes binary, `libmapgen.py` reads it

---

## Data Layout

```c
typedef struct {
    short elevation;
    unsigned char r, g, b;
    unsigned char precip, temp;
    unsigned char flags;
} MapPoint;